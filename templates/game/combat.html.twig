{% extends 'base.html.twig' %}

{% block title %}Combat: {{ enemy.name }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/combat.css') }}">
{% endblock %}

{% block body %}
    {# Fond dynamique : Image de l'ennemi nette pour l'immersion #}
    {% set enemyImageURL = asset('images/enemies/' ~ enemy.image) %}
    <div class="game-page-background" style="background-image: url('{{ enemyImageURL }}'); filter: none !important;"></div>

    <div class="combat-scene-wrapper">
        <div class="combat-container-glass">
            <h1 class="combat-header">Bataille contre le {{ enemy.name }}</h1>

            <div class="combat-arena">
                {# --- CARTE DU JOUEUR --- #}
                <div class="combat-card player-card">
                    <div class="portrait-container">
                        {% set classFileName = player.playerClassName|lower %}
                        {% if classFileName == 'guerrier' %}{% set classFileName = 'warrior' %}
                        {% elseif classFileName == 'mage' %}{% set classFileName = 'mage' %}
                        {% elseif classFileName == 'archer' %}{% set classFileName = 'archer' %}{% endif %}
                        <img src="{{ asset('images/classes/' ~ classFileName ~ '.png') }}" alt="{{ player.playerClassName }}" class="entity-img">
                    </div>
                    <div class="entity-info">
                        <h2 class="entity-name">{{ player.name }}</h2>
                        <div class="hp-container">
                            {% set playerHpPercentage = (player.hp / player.hpMax) * 100 %}
                            <div id="player-hp-fill" class="hp-bar" style="width: {{ playerHpPercentage }}%;"></div>
                        </div>
                        <p class="hp-text-yellow">PV: <span id="player-hp-value">{{ player.hp }}</span> / {{ player.hpMax }}</p>
                        <div class="stats-row">
                            <span>ATK: <span id="player-attack-stat">{{ player.calculateTotalAttack() }}</span></span>
                            <span>DEF: <span id="player-defense-stat">{{ player.calculateTotalDefense() }}</span></span>
                        </div>
                    </div>
                </div>

                {# --- CARTE DE L'ENNEMI --- #}
                <div class="combat-card enemy-card">
                    <div class="portrait-container">
                        <img src="{{ asset('images/enemies/' ~ enemy.image) }}" alt="{{ enemy.name }}" class="entity-img">
                    </div>
                    <div class="entity-info">
                        <h2 class="entity-name">{{ enemy.name }}</h2>
                        <div class="hp-container">
                            {% set enemyHpPercentage = (enemy.hp / enemy.hpMax) * 100 %}
                            <div id="enemy-hp-fill" class="hp-bar" style="width: {{ enemyHpPercentage }}%;"></div>
                        </div>
                        <p class="hp-text-yellow">PV: <span id="enemy-hp-value">{{ enemy.hp }}</span> / {{ enemy.hpMax }}</p>
                        <div class="stats-grid">
                            <span>ATK: {{ enemy.attack }}</span>
                            <span>DEF: {{ enemy.defense }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {# --- INTERFACE DE COMMANDE --- #}
            <div class="combat-controls">
                <div class="action-buttons-group">
                    <button id="attack-button" class="btn-rpg btn-attack">ATTAQUER</button>
                    <a href="{{ path('combat_flee') }}" id="flee-button" class="btn-rpg btn-flee">FUIR</a>
                </div>

                <div class="combat-log-glass">
                    <h3 class="log-title">Journal de Combat</h3>
                    <div id="combat-logs" class="logs-flow">
                        <p class="log-entry">Le combat contre le {{ enemy.name }} commence !</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        function initCombatListeners() {
            const attackButton = document.getElementById('attack-button');
            const logsContainer = document.getElementById('combat-logs');
            const enemyHpValue = document.getElementById('enemy-hp-value');
            const enemyHpFill = document.getElementById('enemy-hp-fill');
            const playerHpValue = document.getElementById('player-hp-value');
            const playerHpFill = document.getElementById('player-hp-fill');
            
            const enemyMaxHp = {{ enemy.hpMax | default(1) }}; 
            const playerMaxHp = {{ player.hpMax | default(1) }}; 

            if (!attackButton || !logsContainer || !enemyHpValue || !playerHpValue) return;

            function scrollToBottom() {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }

            function updateHpDisplay(currentHp, maxHp, hpValueElement, hpFillElement) {
                currentHp = Math.max(0, currentHp); 
                const percentage = (currentHp / maxHp) * 100;
                hpValueElement.textContent = currentHp;
                hpFillElement.style.width = `${percentage}%`;
                
                if (percentage < 25) hpFillElement.style.background = '#e74c3c';
                else if (percentage < 50) hpFillElement.style.background = '#f39c12';
                else hpFillElement.style.background = 'linear-gradient(to right, #2ecc71, #27ae60)';
            }

            function addLogEntry(message, type = 'info') {
                const logTypeClass = type !== 'info' ? `log-${type}` : '';
                logsContainer.innerHTML += `<p class="log-entry ${logTypeClass}">${message}</p>`;
                scrollToBottom();
            }

            attackButton.addEventListener('click', function() {
                attackButton.disabled = true;

                fetch('{{ path("combat_attack") }}', { method: 'POST' })
                .then(response => response.ok ? response.json() : Promise.reject())
                .then(data => {
                    if (data.status === 'ongoing') {
                        updateHpDisplay(data.enemyHp, enemyMaxHp, enemyHpValue, enemyHpFill);
                        addLogEntry(`Vous infligez <span style="color:#2ecc71;font-weight:bold;">${data.damageDealt}</span> dégâts.`);
                        
                        setTimeout(() => {
                            updateHpDisplay(data.playerHp, playerMaxHp, playerHpValue, playerHpFill);
                            addLogEntry(`L'ennemi inflige <span style="color:#e74c3c;font-weight:bold;">${data.damageTaken}</span> dégâts.`);
                            attackButton.disabled = false;
                        }, 400);

                    } else if (data.status === 'victory') {
                        updateHpDisplay(0, enemyMaxHp, enemyHpValue, enemyHpFill); 
                        addLogEntry(`Coup Fatal ! VICTOIRE !`, 'success');
                        if(data.leveledUp) addLogEntry(`NIVEAU SUPÉRIEUR (${data.newLevel}) !`, 'success');
                        setTimeout(() => window.location.href = data.redirectUrl, 2000); 

                    } else if (data.status === 'defeat') {
                        updateHpDisplay(0, playerMaxHp, playerHpValue, playerHpFill);
                        addLogEntry(`Vous avez succombé...`, 'defeat');
                        setTimeout(() => window.location.href = data.redirectUrl, 2000);
                    }
                })
                .catch(() => {
                    addLogEntry('Erreur de connexion.', 'error');
                    attackButton.disabled = false;
                });
            });
        }
        window.addEventListener('pageshow', initCombatListeners);
    </script>
{% endblock %}