{% extends 'base.html.twig' %}

{% block title %}Combat: {{ enemy.name }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/combat.css') }}">
{% endblock %}

{% block body %}
    {# --- FOND DYNAMIQUE : Utilise l'image de l'ennemi pour le fond flou --- #}
    {% set enemyImageURL = asset('images/enemies/' ~ enemy.name|lower ~ '.png') %}
    <div class="game-page-background" style="--blurred-bg-image: url('{{ enemyImageURL }}');"></div>
    {# -------------------------------------------------------------------------- #}
    
    <div class="combat-container">
        <h1>Bataille contre le {{ enemy.name }}</h1>

        <div class="combat-area">
            
            {# ========================================== #}
            {# CARTE DU JOUEUR (Gauche) #}
            {# ========================================== #}
            <div class="combat-card player-area">
                
                <div class="portrait-box">
                    {# Gestion dynamique des images de classe #}
                    {% set classFileName = player.playerClassName|lower %}
                    {% if classFileName == 'guerrier' %}{% set classFileName = 'warrior' %}
                    {% elseif classFileName == 'mage' %}{% set classFileName = 'mage' %}
                    {% elseif classFileName == 'archer' %}{% set classFileName = 'archer' %}{% endif %}
                    
                    <img src="{{ asset('images/classes/' ~ classFileName ~ '.png') }}" alt="{{ player.playerClassName }}" class="entity-image">
                </div>
                
                <h2 class="entity-name">{{ player.name }}</h2>
                
                <div class="stats-box">
                    {# Barre de Vie du Joueur #}
                    <div class="hp-bar-container player-hp-bar">
                        {% set playerHpPercentage = (player.hp / player.hpMax) * 100 %}
                        <div id="player-hp-fill" class="hp-bar-fill" style="width: {{ playerHpPercentage }}%;"></div>
                    </div>
                    <p class="hp-text">PV: <span id="player-hp-value">{{ player.hp }}</span> / {{ player.hpMax }}</p>
                    
                    <div class="stats-grid">
                        <p>Attaque: <span id="player-attack-stat">{{ player.calculateTotalAttack() }}</span></p>
                        <p>Défense: <span id="player-defense-stat">{{ player.calculateTotalDefense() }}</span></p>
                    </div>
                </div>

            </div>

            {# ========================================== #}
            {# CARTE DE L'ENNEMI (Droite) #}
            {# ========================================== #}
            <div class="combat-card enemy-area">

                <div class="portrait-box">
                    <img src="{{ asset('images/enemies/' ~ enemy.name|lower ~ '.png') }}" alt="{{ enemy.name }}" class="entity-image">
                </div>
                
                <h2 class="entity-name">{{ enemy.name }}</h2>

                <div class="stats-box">
                    {# Barre de Vie de l'Ennemi #}
                    <div class="hp-bar-container enemy-hp-bar">
                        {% set enemyHpPercentage = (enemy.hp / enemy.hpMax) * 100 %}
                        <div id="enemy-hp-fill" class="hp-bar-fill" style="width: {{ enemyHpPercentage }}%;"></div>
                    </div>
                    <p class="hp-text">PV: <span id="enemy-hp-value">{{ enemy.hp }}</span> / {{ enemy.hpMax }}</p>
                    
                    <div class="stats-grid">
                        <p>Attaque: {{ enemy.attack }}</p>
                        <p>Défense: {{ enemy.defense }}</p>
                    </div>
                </div>

            </div>
        </div>

        {# Zone des Actions et des Logs (Centrée en bas) #}
        <div class="combat-interface">
            <div class="action-buttons">
                <button id="attack-button" class="action-button attack-action-btn">Attaquer</button>
                <a href="{{ path('combat_flee') }}" id="flee-button" class="action-button flee-action-btn">Fuir</a>
            </div>

            <div class="combat-logs-panel">
                <h3>Journal de Combat</h3>
                <div id="combat-logs" class="logs-content">
                    <p class="log-entry">Le combat contre le {{ enemy.name }} commence !</p>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{#
    ========================================================================================
    CORRECTION CRITIQUE: Le code JS est remis dans le bloc 'javascripts'.
    Pour résoudre le problème de bouton non fonctionnel au premier chargement, 
    nous retirons l'appel au parent, ce qui empêche le conflit avec Stimulus/AssetMapper.
    ========================================================================================
#}
{% block javascripts %}
    <script>
        // Fonction principale qui attache TOUS les événements
        function initCombatListeners() {
            const attackButton = document.getElementById('attack-button');
            const logsContainer = document.getElementById('combat-logs');
            
            // Éléments PV
            const enemyHpValue = document.getElementById('enemy-hp-value');
            const enemyHpFill = document.getElementById('enemy-hp-fill');
            const playerHpValue = document.getElementById('player-hp-value');
            const playerHpFill = document.getElementById('player-hp-fill');
            
            // NOTE: Twig rend ces variables, assurez-vous qu'elles ne sont pas NULL/0.
            const enemyMaxHp = {{ enemy.hpMax | default(1) }}; 
            const playerMaxHp = {{ player.hpMax | default(1) }}; 

            // Si un élément critique est manquant, on sort 
            if (!attackButton || !logsContainer || !enemyHpValue || !playerHpValue) {
                console.error("Échec de l'attachement des événements: un élément HTML critique est manquant.");
                return;
            }

            // Assure le défilement vers le bas des logs
            function scrollToBottom() {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }

            // Met à jour la barre de vie et le texte pour l'entité donnée
            function updateHpDisplay(currentHp, maxHp, hpValueElement, hpFillElement) {
                currentHp = Math.max(0, currentHp); 
                
                const percentage = (currentHp / maxHp) * 100;
                hpValueElement.textContent = currentHp;
                hpFillElement.style.width = `${percentage}%`;
                
                // Gérer les couleurs de la barre (logique conservée)
                if (percentage < 25) {
                    hpFillElement.style.backgroundColor = '#e74c3c'; // Rouge
                } else if (percentage < 50) {
                    hpFillElement.style.backgroundColor = '#f39c12'; // Orange
                } else {
                    hpFillElement.style.backgroundColor = '#2ecc71'; // Vert
                }
            }

            // Gère le clic sur le bouton Attaquer
            attackButton.addEventListener('click', function() {
                attackButton.disabled = true;

                fetch('{{ path("combat_attack") }}', { method: 'POST' })
                .then(response => {
                    // Vérifier la réponse du serveur (404, 500, etc.)
                    if (!response.ok) {
                        return response.text().then(text => { 
                            console.error("Erreur serveur lors de l'attaque:", text);
                            throw new Error('Erreur réponse non JSON ou statut non OK.'); 
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    
                    function addLogEntry(message, type = 'info') {
                        logsContainer.innerHTML += `<p class="log-entry log-${type}">${message}</p>`;
                        scrollToBottom();
                    }
                    
                    if (data.status === 'ongoing') {
                        // 1. Mise à jour de l'ennemi
                        updateHpDisplay(data.enemyHp, enemyMaxHp, enemyHpValue, enemyHpFill);
                        addLogEntry(`Vous infligez <span class="damage-dealt">${data.damageDealt}</span> dégâts au ${data.enemyName}.`);
                        
                        // 2. Mise à jour du joueur
                        updateHpDisplay(data.playerHp, playerMaxHp, playerHpValue, playerHpFill);
                        addLogEntry(`Le ${data.enemyName} vous inflige <span class="damage-taken">${data.damageTaken}</span> dégâts !`);
                        
                        attackButton.disabled = false;
                        
                    } else if (data.status === 'victory') {
                        // Ennemi vaincu
                        updateHpDisplay(0, enemyMaxHp, enemyHpValue, enemyHpFill); 
                        addLogEntry(`Vous infligez <span class="damage-dealt">${data.damageDealt}</span> dégâts (Coup Fatal).`);
                        addLogEntry(`VICTOIRE ! Vous avez vaincu le ${data.enemyName}.`, 'success');
                        
                        // Note: Les gains XP/Or sont gérés par le contrôleur (session) pour la page de résultat.
                        
                        if(data.leveledUp) {
                            addLogEntry(`NIVEAU SUPÉRIEUR ! Vous êtes maintenant au niveau ${data.newLevel} !`, 'success');
                        }

                        setTimeout(() => {
                            window.location.href = data.redirectUrl;
                        }, 2000); 
                        
                    } else if (data.status === 'defeat') {
                        // Joueur vaincu
                        updateHpDisplay(0, playerMaxHp, playerHpValue, playerHpFill);
                        addLogEntry(`Le ${data.enemyName} vous inflige <span class="damage-taken">${data.damageTaken}</span> dégâts (Coup Fatal).`);
                        addLogEntry(`DÉFAITE... Le ${data.enemyName} vous a vaincu.`, 'defeat');
                        
                        // Rediriger vers la page de résultat après un court délai
                        setTimeout(() => {
                            window.location.href = data.redirectUrl;
                        }, 2000);
                    } else {
                        addLogEntry('Erreur de combat : ' + data.message, 'error');
                        attackButton.disabled = false;
                    }

                })
                .catch(error => {
                    console.error('Erreur AJAX de combat:', error);
                    logsContainer.innerHTML += '<p class="log-entry log-error">Erreur de communication avec le serveur ou JSON invalide.</p>';
                    scrollToBottom();
                    attackButton.disabled = false;
                });
            });
        } // Fin de initCombatListeners

        // L'écouteur est appelé dès que le DOM est prêt.
        document.addEventListener('DOMContentLoaded', function() {
            initCombatListeners(); 
        });
    </script>
{% endblock %}